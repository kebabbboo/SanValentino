<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">

<title>Lilian ‚ú®</title>

<style>
  * { box-sizing: border-box; }

  :root{
    --bg1:#0f0f12;
    --bg2:#1b1b22;
    --gold:#d8b67a;
    --gold2:#f1dfb1;
    --rose:#ff4d6d;
    --card:#111218cc;
    --card2:#171824cc;
    --text:#f5f2ea;
    --muted:#cfc7bb;
    --shadow: 0 18px 45px rgba(0,0,0,.45);
   --font-body: "Inter", Arial, sans-serif;
--font-title: "Playfair Display", Georgia, serif;

  }

  body{
    margin:0;
    min-height:100vh;
    font-family: var(--font-body);
    display:flex;
    justify-content:center;
    align-items:center;
    overflow:auto;
    padding: 18px 0;

    background:
      radial-gradient(1000px 700px at 20% 10%, rgba(216,182,122,.18), rgba(0,0,0,0)),
      radial-gradient(900px 700px at 85% 15%, rgba(255,77,109,.14), rgba(0,0,0,0)),
      linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--text);
  }

  .frame{
    width: 92%;
    max-width: 430px;
    border-radius: 26px;
    padding: 2px;
    background: linear-gradient(135deg, rgba(241,223,177,.95), rgba(216,182,122,.25), rgba(255,77,109,.18));
    box-shadow: var(--shadow);
  }

  .card{
    border-radius: 24px;
    padding: 18px;
    background: linear-gradient(180deg, var(--card), var(--card2));
    backdrop-filter: blur(10px);
    position: relative;

    max-height: 80vh;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  .topRow{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 999px;
    background: rgba(216,182,122,.12);
    border: 1px solid rgba(216,182,122,.26);
    color: var(--gold2);
    font-weight: 700;
    font-size: 12.5px;
    letter-spacing: .3px;
  }

  h1{
    margin: 6px 0 8px;
    font-size: 26px;
    letter-spacing: .3px;
    color: var(--gold2);
   font-family: var(--font-title);

  }

  p{
    margin: 10px 0;
    font-size: 16px;
    line-height: 1.35;
    color: rgba(245,242,234,.95);
  }

  .muted{
    color: rgba(207,199,187,.92);
    font-size: 14px;
    margin-top: 0;
  }

  .divider{
    height:1px;
    background: linear-gradient(90deg, transparent, rgba(216,182,122,.25), transparent);
    margin: 14px 0;
  }

  .buttons{
    margin-top: 16px;
    height: 124px;
    position: relative;
  }

  button{
    border: none;
    border-radius: 999px;
    padding: 13px 18px;
    font-size: 16px;
    cursor: pointer;
    transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    user-select:none;
  }
  button:active{ transform: translateY(1px) scale(.99); }

  #yesBtn{
    position:absolute;
    left:50%;
    top:0;
    transform: translateX(-50%);
    color: #19171a;
    background: linear-gradient(135deg, var(--gold2), var(--gold));
    box-shadow: 0 14px 26px rgba(216,182,122,.25);
    font-weight: 800;
    letter-spacing: .2px;
  }

  #noBtn{
    position:absolute;
    left:50%;
    top:64px;
    transform: translateX(-50%);
    color: rgba(245,242,234,.92);
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    touch-action: manipulation;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding: 9px 12px;
    border-radius: 999px;
    background: rgba(216,182,122,.10);
    border: 1px solid rgba(216,182,122,.22);
    color: rgba(241,223,177,.95);
    font-size: 13px;
    margin-top: 10px;
  }

  .hidden{ display:none; }

  .photo{
    width:100%;
    max-height: 220px;
    object-fit: cover;
    border-radius: 18px;
    margin: 10px 0 6px;
    box-shadow: 0 18px 35px rgba(0,0,0,.35);
    animation: photoIn 520ms ease both;
  }
  @keyframes photoIn{
    from{ opacity:0; transform: translateY(8px) scale(.97); }
    to{ opacity:1; transform: translateY(0) scale(1); }
  }

  .grid{ display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }

  .panel{
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(216,182,122,.18);
    border-radius: 18px;
    padding: 12px;
    position: relative;
    overflow:hidden;
  }

  .panel::before{
    content:"";
    position:absolute;
    left:0; top:0; bottom:0;
    width: 10px;
    background: linear-gradient(180deg, rgba(241,223,177,.45), rgba(255,77,109,.25));
    opacity:.8;
  }

  .panelHeader{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 8px;
    padding-left: 10px;
  }

  .panelTitle{
    margin:0;
    font-size: 14.5px;
    color: rgba(241,223,177,.95);
    display:flex;
    align-items:center;
    gap: 8px;
    letter-spacing: .2px;
  }

  .result{
    margin-top: 8px;
    font-size: 14.5px;
    color: rgba(245,242,234,.94);
    text-align:center;
    padding-left: 10px;
  }

  /* Slider */
  .sliderWrap{ display:grid; gap:8px; justify-items:center; padding-left:10px; }

  #loveRange{
    width:100%;
    accent-color: var(--rose);
    -webkit-appearance:none;
    appearance:none;
    height: 10px;
    border-radius: 999px;
    outline:none;
    background: linear-gradient(90deg, var(--rose) 50%, rgba(255,77,109,.18) 50%);
  }
  #loveRange::-webkit-slider-runnable-track{ height:10px; border-radius:999px; background: transparent; }
  #loveRange::-moz-range-track{ height:10px; border-radius:999px; background: transparent; }

  #loveRange::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width: 30px;
    height: 30px;
    border-radius: 999px;
    border: 2px solid rgba(255,255,255,.75);
    cursor:pointer;
    margin-top: -10px;
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.7) 0 18%, rgba(255,255,255,0) 19% 100%),
      radial-gradient(circle at 55% 65%, rgba(255,190,90,.95) 0 35%, rgba(255,110,70,.95) 55%, rgba(255,77,109,1) 100%);
    box-shadow:
      0 10px 18px rgba(255,77,109,.20),
      0 0 16px rgba(255,110,70,.45);
  }
  #loveRange::-moz-range-thumb{
    width: 30px; height:30px; border-radius:999px;
    border: 2px solid rgba(255,255,255,.75);
    cursor:pointer;
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.7) 0 18%, rgba(255,255,255,0) 19% 100%),
      radial-gradient(circle at 55% 65%, rgba(255,190,90,.95) 0 35%, rgba(255,110,70,.95) 55%, rgba(255,77,109,1) 100%);
    box-shadow:
      0 10px 18px rgba(255,77,109,.20),
      0 0 16px rgba(255,110,70,.45);
  }

  /* Scratch */
  .scratchWrap{
    position:relative;
    border-radius: 18px;
    overflow:hidden;
    border: 1px dashed rgba(241,223,177,.55);
    background: rgba(0,0,0,.18);
    margin-left: 10px;
    min-height: 130px;
  }

  .scratchPrize{
    position: relative;
    z-index: 1;
    padding: 14px 14px 16px;
    text-align:center;
  }

  .scratchPrize .big{
    font-size: 18px;
    color: rgba(241,223,177,.98);
    font-weight: 900;
    margin-bottom: 6px;
    letter-spacing: .6px;
  }
  .scratchPrize .small{
    font-size: 14px;
    color: rgba(245,242,234,.94);
    opacity:.95;
  }

  canvas#scratchCanvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    touch-action:none;
    cursor:grab;
    z-index: 5;
  }

  .scratchHint{
    margin-top: 8px;
    font-size: 13px;
    color: rgba(241,223,177,.9);
    text-align:center;
    opacity:.9;
    padding-left: 10px;
  }

  /* Cuori che salgono */
  .heart{
    position: fixed;
    bottom:-30px;
    animation: floatUp 4.2s linear forwards;
    pointer-events:none;
    filter: drop-shadow(0 8px 10px rgba(0,0,0,.35));
  }
  @keyframes floatUp{ to{ transform: translateY(-110vh); opacity:0; } }

  /* ‚úÖ NUOVA animazione al completamento scratch: Sparkle Burst */
  .burstPiece{
    position:absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    pointer-events:none;
    z-index: 40;
    opacity: 0;
    animation: burst 900ms ease-out forwards;
    text-shadow: 0 10px 16px rgba(0,0,0,.35);
  }
  @keyframes burst{
    0%   { opacity:0; transform: translate(-50%,-50%) scale(.8); }
    15%  { opacity:1; }
    100% { opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.15); }
  }

  /* ‚úÖ KISS COUNTER nuovo */
  .kissWrap{ padding-left: 10px; display:grid; gap: 10px; }
  .kissTop{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
  }
  .kissBig{
    font-size: 32px;
    font-weight: 900;
    letter-spacing: .6px;
    color: rgba(241,223,177,.98);
    line-height: 1;
    display:flex;
    align-items: baseline;
    gap: 8px;
  }
  .kissBig span{
    font-size: 13px;
    color: rgba(207,199,187,.95);
    font-weight: 700;
    letter-spacing: .2px;
  }

  .kissBar{
    width:100%;
    height: 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(216,182,122,.18);
    overflow:hidden;
  }
  .kissFill{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(241,223,177,.95), rgba(255,77,109,.65));
    border-radius: 999px;
    transition: width 180ms ease;
  }

  .kissBtns{
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content:center;
  }
  .kissBtn{
    background: linear-gradient(135deg, rgba(241,223,177,.92), rgba(216,182,122,.55));
    color:#16151a;
    font-weight: 900;
    box-shadow: 0 14px 26px rgba(216,182,122,.16);
  }
  .kissReset{
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(241,223,177,.20);
    color: rgba(245,242,234,.92);
  }

  .pop{
    animation: pop 220ms ease-out;
  }
  @keyframes pop{
    0%{ transform: scale(1); }
    50%{ transform: scale(1.06); }
    100%{ transform: scale(1); }
  }

  /* mini cuoricini quando clicchi bacio */
  .kissFloat{
    position:absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    pointer-events:none;
    opacity: 0;
    animation: kissFloat 900ms ease-out forwards;
    z-index: 30;
    filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
  }
  @keyframes kissFloat{
    0%{ opacity:0; transform: translateX(-50%) translateY(0) scale(.9); }
    15%{ opacity:1; }
    100%{ opacity:0; transform: translateX(calc(-50% + var(--dx))) translateY(-110px) scale(1.15); }
  }
</style>
</head>

<body>
  <div class="frame">
    <div class="card" id="card">
      <div class="topRow">
        <div class="badge">ü•Ç Invito a cena</div>
      </div>

      <h1>Ciao Lilian ‚ú®</h1>
      <p class="muted">Un invito elegante‚Ä¶ con un pizzico di giocheria üòå</p>

      <p>
        Domanda importantissima:<br><br>
        Vuoi essere la mia <strong>Valentina di San Valentino</strong>? ‚ù§Ô∏è
      </p>

      <div class="buttons">
        <button id="yesBtn">S√å üíò</button>
        <button id="noBtn">NO üôÑ</button>
      </div>

      <div id="status" class="pill hidden">‚ú®</div>

      <div class="divider"></div>

      <div id="final" class="hidden">
        <h1>Perfetto. ‚ù§Ô∏è</h1>

        <img
          class="photo"
          alt="Noi üíñ"
          src="https://images.unsplash.com/photo-1529634806980-85c3dd6d34ac?auto=format&fit=crop&w=1200&q=80"
        />

        <p>
          Allora √® deciso üòå<br><br>
          Una cena elegante, un brindisi‚Ä¶ e poi il resto lo vediamo dopo üíñ
        </p>

        <div class="grid">
          <div class="panel" id="scratchPanel">
            <div class="panelHeader">
              <h3 class="panelTitle">üéüÔ∏è Gratta e scopri</h3>
            </div>

            <div class="scratchWrap" id="scratchBox">
              <div class="scratchPrize">
                <!-- üëá Cambia questo testo come vuoi -->
                <div class="big">PREMIO SEGRETO ‚ú®</div>
                <div class="small">
                  Hai vinto: una serata bellissima con me + coccole illimitate üòå‚ù§Ô∏è<br>
                  (e forse anche una sorpresa‚Ä¶)
                </div>
              </div>
              <canvas id="scratchCanvas"></canvas>
            </div>

            <div class="scratchHint" id="scratchHint">Gratta con il dito per scoprire il premio ‚ú®</div>
          </div>

          <div class="panel">
            <div class="panelHeader">
              <h3 class="panelTitle">üî• Misuratore di amore</h3>
            </div>
            <div class="sliderWrap">
              <input id="loveRange" type="range" min="0" max="100" value="50" />
              <div id="loveText" class="result">Direi che siamo gi√† ad un ottimo livello üòå</div>
            </div>
          </div>

          <div class="panel" id="kissPanel">
            <div class="panelHeader">
              <h3 class="panelTitle">üòö Kiss Counter</h3>
            </div>

            <div class="kissWrap">
              <div class="kissTop">
                <div class="kissBig" id="kissBig">0 <span>baci</span></div>
                <div style="color: rgba(207,199,187,.92); font-size: 13px; font-weight:700;">
                  obiettivo: <span id="kissGoal">30</span>
                </div>
              </div>

              <div class="kissBar">
                <div class="kissFill" id="kissFill"></div>
              </div>

              <div class="kissBtns">
                <button class="kissBtn" id="kissBtn">Bacio +1 üíã</button>
                <button class="kissReset" id="resetKissBtn">Reset üòá</button>
              </div>

              <div id="kissResult" class="result">Vai piano‚Ä¶ o non rispondo pi√π üòè</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="music" loop>
    <source src="https://cdn.pixabay.com/audio/2022/10/30/audio_946b6b1c6d.mp3" type="audio/mpeg">
  </audio>

<script>
  const card = document.getElementById("card");

  const yesBtn = document.getElementById("yesBtn");
  const noBtn = document.getElementById("noBtn");
  const finalBox = document.getElementById("final");
  const status = document.getElementById("status");
  const music = document.getElementById("music");

  const loveRange = document.getElementById("loveRange");
  const loveText = document.getElementById("loveText");

  const scratchPanel = document.getElementById("scratchPanel");
  const scratchBox = document.getElementById("scratchBox");
  const scratchCanvas = document.getElementById("scratchCanvas");
  const scratchHint = document.getElementById("scratchHint");

  const kissPanel = document.getElementById("kissPanel");
  const kissBtn = document.getElementById("kissBtn");
  const resetKissBtn = document.getElementById("resetKissBtn");
  const kissResult = document.getElementById("kissResult");
  const kissFill = document.getElementById("kissFill");
  const kissBig = document.getElementById("kissBig");
  const kissGoalEl = document.getElementById("kissGoal");

  let noCount = 0;
  let heartsStarted = false;

  // Kisses
  let kisses = 0;
  const kissGoal = 30;

  // Scratch
  let ctx = null;
  let isScratching = false;
  let scratchedEnough = false;
  let ratio = 1;

  function vibrate(pattern) {
    try { if (navigator.vibrate) navigator.vibrate(pattern); } catch (_) {}
  }

  function showStatus(msg) {
    status.textContent = "‚ú® " + msg;
    status.classList.remove("hidden");
  }

  function moveNoButton() {
    const container = document.querySelector(".buttons");
    const c = container.getBoundingClientRect();
    const b = noBtn.getBoundingClientRect();

    const padding = 8;
    const maxLeft = c.width - b.width - padding * 2;
    const maxTop  = c.height - b.height - padding * 2;

    const left = padding + Math.random() * Math.max(10, maxLeft);
    const top  = padding + Math.random() * Math.max(10, maxTop);

    noBtn.style.left = left + "px";
    noBtn.style.top  = top + "px";
    noBtn.style.transform = "none";
  }

  function startHearts() {
    if (heartsStarted) return;
    heartsStarted = true;

    setInterval(() => {
      const heart = document.createElement("div");
      heart.className = "heart";
      heart.textContent = ["‚ù§Ô∏è","üíñ","üíï","üíó","üíò"][Math.floor(Math.random()*5)];
      heart.style.left = (Math.random() * 100) + "vw";
      heart.style.fontSize = (Math.random() * 22 + 14) + "px";
      document.body.appendChild(heart);
      setTimeout(() => heart.remove(), 4200);
    }, 260);
  }

  function doYesFlow() {
    finalBox.classList.remove("hidden");
    showStatus("questa √® la scelta giusta üòå");
    vibrate([40, 30, 40]);

    music.volume = 0.30;
    music.play().catch(() => {});

    startHearts();
    initScratch();

    yesBtn.disabled = true;
    noBtn.disabled = true;
  }

  // Slider fill
  function paintLoveRange(){
    const v = Number(loveRange.value);
    loveRange.style.background =
      `linear-gradient(90deg, #ff4d6d ${v}%, rgba(255,77,109,.18) ${v}%)`;
  }

  function updateLoveText(v) {
    if (v < 20) return "Ok‚Ä¶ timida. Ma ti recupero a colpi di coccole üòå";
    if (v < 40) return "Stai iniziando a convincerti‚Ä¶ bravissima üòè";
    if (v < 60) return "Direi che siamo gi√† ad un ottimo livello üòå";
    if (v < 80) return "Wow. Qui siamo pericolosamente innamorati üíï";
    return "Allarme: livello amore massimo. Procedo con baci immediati üíò";
  }

  paintLoveRange();
  loveText.textContent = updateLoveText(Number(loveRange.value));
  loveRange.addEventListener("input", () => {
    loveText.textContent = updateLoveText(Number(loveRange.value));
    paintLoveRange();
  });

  // Buttons
  yesBtn.addEventListener("click", doYesFlow);

  noBtn.addEventListener("click", () => {
    noCount++;
    vibrate(25);

    if (noCount < 5) {
      const left = 5 - noCount;
      showStatus(`no? sei sicura? üòè (mancano ${left})`);
      moveNoButton();
      const texts = ["NO üôÑ", "NO? ü§®", "Ancora NO? üòå", "Dai su üòè", "Ok basta üò≥"];
      noBtn.textContent = texts[Math.min(noCount, texts.length - 1)];
    } else {
      showStatus("ok ok‚Ä¶ mi arrendo üî•");
      noBtn.textContent = "Ok‚Ä¶ S√å ‚ù§Ô∏è";
      noBtn.style.background = "linear-gradient(135deg, #f1dfb1, #d8b67a)";
      noBtn.style.color = "#19171a";
      noBtn.onclick = () => doYesFlow();
      vibrate([60, 40, 60]);
    }
  });

  /* ---------- KISS COUNTER (nuovo) ---------- */
  kissGoalEl.textContent = String(kissGoal);

  function updateKissUI(){
    kissBig.textContent = `${kisses} `;
    const span = document.createElement("span");
    span.textContent = "baci";
    kissBig.appendChild(span);

    const pct = Math.min(100, Math.round((kisses / kissGoal) * 100));
    kissFill.style.width = pct + "%";

    if (kisses === 0) kissResult.textContent = "Vai piano‚Ä¶ o non rispondo pi√π üòè";
    else if (kisses < 10) kissResult.textContent = "Ok‚Ä¶ cos√¨ mi piace üòå";
    else if (kisses < 20) kissResult.textContent = "Qui la situazione sta diventando seria üíñ";
    else if (kisses < kissGoal) kissResult.textContent = "Ancora un po‚Äô‚Ä¶ e sblocchi il ‚Äòpremio‚Äô üòè";
    else kissResult.textContent = "‚úÖ Sbloccato: ‚Äòstasera non scappi‚Äô ü•Ç‚ù§Ô∏è";
  }

  function kissPop(){
    kissBig.classList.remove("pop");
    void kissBig.offsetWidth;
    kissBig.classList.add("pop");
  }

  function spawnKissFloat(){
    const el = document.createElement("div");
    el.className = "kissFloat";
    el.textContent = ["üíã","üíï","üíñ","‚ù§Ô∏è","‚ú®"][Math.floor(Math.random()*5)];
    el.style.setProperty("--dx", (Math.random()*120 - 60) + "px");
    kissPanel.appendChild(el);
    setTimeout(() => el.remove(), 950);
  }

  updateKissUI();

  kissBtn.addEventListener("click", () => {
    kisses++;
    vibrate(12);
    updateKissUI();
    kissPop();
    spawnKissFloat();
  });

  resetKissBtn.addEventListener("click", () => {
    kisses = 0;
    updateKissUI();
    vibrate([20,20,20]);
  });

  /* ---------- SCRATCH: animazione finale (Sparkle Burst) ---------- */
  function sparkleBurst(){
    const pieces = 16;
    const symbols = ["‚ú®","‚≠ê","üí´","‚ù§Ô∏è","ü•Ç"];
    for (let i = 0; i < pieces; i++) {
      const s = document.createElement("div");
      s.className = "burstPiece";
      s.textContent = symbols[Math.floor(Math.random()*symbols.length)];
      const dx = (Math.random()*240 - 120).toFixed(0) + "px";
      const dy = (Math.random()*220 - 110).toFixed(0) + "px";
      s.style.setProperty("--dx", dx);
      s.style.setProperty("--dy", dy);
      s.style.fontSize = (14 + Math.random()*14).toFixed(0) + "px";
      scratchPanel.appendChild(s);
      setTimeout(() => s.remove(), 950);
    }
  }

  function resizeCanvasToBox() {
    const rect = scratchBox.getBoundingClientRect();
    ratio = Math.max(1, window.devicePixelRatio || 1);

    scratchCanvas.width = Math.floor(rect.width * ratio);
    scratchCanvas.height = Math.floor(rect.height * ratio);

    scratchCanvas.style.width = rect.width + "px";
    scratchCanvas.style.height = rect.height + "px";

    ctx = scratchCanvas.getContext("2d");
    ctx.setTransform(1, 0, 0, 1, 0, 0); // pixel reali
  }

  function drawCover() {
    if (!ctx) return;

    const w = scratchCanvas.width;
    const h = scratchCanvas.height;

    // cover opaca (non si vede sotto)
    const g = ctx.createLinearGradient(0, 0, w, h);
    g.addColorStop(0, "#1c1b21");
    g.addColorStop(0.55, "#15141a");
    g.addColorStop(1, "#101015");

    ctx.globalCompositeOperation = "source-over";
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, w, h);

    // foil dorato leggero
    for (let i = 0; i < 120; i++) {
      ctx.fillStyle = `rgba(216,182,122,${Math.random() * 0.08})`;
      ctx.beginPath();
      ctx.arc(Math.random() * w, Math.random() * h, Math.random() * 3 + 0.5, 0, Math.PI * 2);
      ctx.fill();
    }

    ctx.fillStyle = "rgba(241,223,177,0.95)";
    ctx.font = `900 ${Math.floor(18 * ratio)}px Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("GRATTA QUI ‚ú®", w / 2, h / 2);
  }

  function scratchAt(clientX, clientY) {
    if (!ctx || scratchedEnough) return;

    const rect = scratchCanvas.getBoundingClientRect();
    const xCss = clientX - rect.left;
    const yCss = clientY - rect.top;

    const x = Math.floor(xCss * ratio);
    const y = Math.floor(yCss * ratio);

    ctx.globalCompositeOperation = "destination-out";
    ctx.beginPath();
    ctx.arc(x, y, Math.floor(18 * ratio), 0, Math.PI * 2);
    ctx.fill();

    checkScratchProgress(false);
  }

  let lastCheck = 0;
  function checkScratchProgress(force){
    const now = Date.now();
    if (!force && now - lastCheck < 250) return;
    lastCheck = now;

    const w = scratchCanvas.width;
    const h = scratchCanvas.height;

    const img = ctx.getImageData(0, 0, w, h).data;

    const stride = 24;
    let cleared = 0;
    let total = 0;

    for (let i = 3; i < img.length; i += 4 * stride) {
      total++;
      if (img[i] < 25) cleared++;
    }

    const pct = cleared / Math.max(1, total);

    if (pct > 0.45 && !scratchedEnough) {
      scratchedEnough = true;
      scratchHint.textContent = "Premio sbloccato ü•Ç‚ú®";
      vibrate([30, 30, 30]);
      ctx.clearRect(0, 0, w, h);

      // ‚úÖ animazione sempre funzionante
      sparkleBurst();
    }
  }

  function initScratch() {
    if (ctx) return;

    resizeCanvasToBox();
    drawCover();

    const onDown = (e) => {
      isScratching = true;
      const p = getPoint(e);
      scratchAt(p.x, p.y);
      vibrate(8);
    };

    const onMove = (e) => {
      if (!isScratching) return;
      e.preventDefault();
      const p = getPoint(e);
      scratchAt(p.x, p.y);
    };

    const onUp = () => {
      isScratching = false;
      if (ctx && !scratchedEnough) checkScratchProgress(true);
    };

    scratchCanvas.addEventListener("pointerdown", onDown);
    scratchCanvas.addEventListener("pointermove", onMove);
    window.addEventListener("pointerup", onUp);

    window.addEventListener("resize", () => {
      const already = scratchedEnough;
      ctx = null;
      resizeCanvasToBox();
      if (!already) drawCover();
    }, { passive: true });
  }

  function getPoint(e) {
    if (e.touches && e.touches[0]) {
      return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
    return { x: e.clientX, y: e.clientY };
  }
</script>

</body>
</html>

