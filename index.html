<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ammor mi' ‚ú®</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">

<style>
  *{ box-sizing:border-box; }

  :root{
    --bg1:#0b0b10;
    --bg2:#141526;

    --gold:#d8b67a;
    --gold2:#f1dfb1;

    --rose:#ff5a76;
    --roseSoft: rgba(255,90,118,.085);

    --text:#f5f2ea;
    --muted:#cfc7bb;

    --card1: rgba(14,15,22,.74);
    --card2: rgba(18,19,30,.64);

    --panel1: rgba(255,255,255,.045);
    --panel2: rgba(255,255,255,.028);

    --shadow: 0 24px 70px rgba(0,0,0,.58);

    --font-body: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    --font-title: "Playfair Display", Georgia, serif;
  }

  body{
    margin:0;
    min-height:100vh;
    font-family: var(--font-body);
    color: var(--text);
    display:flex;
    justify-content:center;
    align-items:center;
    overflow:auto;
    padding: 18px 0;

    background:
      radial-gradient(1150px 820px at 18% 10%, rgba(216,182,122,.14), rgba(0,0,0,0)),
      radial-gradient(950px 820px at 88% 18%, var(--roseSoft), rgba(0,0,0,0)),
      radial-gradient(900px 700px at 50% 92%, rgba(241,223,177,.06), rgba(0,0,0,0)),
      linear-gradient(135deg, var(--bg1), var(--bg2));
  }

  /* =========================
     üíõ GOLD AMBIENT (SOLO con musica ON)
     Nota: sta dietro alla card, ma la card con backdrop-filter lo ‚Äúrisucchia‚Äù.
     Fix: quando ON rendiamo la card pi√π opaca e riduciamo backdrop.
     ========================= */

 #ambientGlow{
  position: fixed;
  inset: -35vh -35vw;
  z-index: 0;
  pointer-events: none;
  opacity: 0;
  transition: opacity 420ms ease;
  filter: blur(16px) saturate(1.35);
  background:
    radial-gradient(1100px 860px at 50% 35%,
      rgba(241,223,177,.22),
      rgba(216,182,122,.14) 46%,
      rgba(0,0,0,0) 74%),
    radial-gradient(780px 620px at 50% 34%,
      rgba(241,223,177,.30),
      rgba(216,182,122,.18) 42%,
      rgba(0,0,0,0) 70%);
}

#ambientGlow.on{
  opacity: 1;
  animation: ambientPulse 1.15s ease-in-out infinite;
}

@keyframes ambientGlow{
  0%   { opacity:0; }
  30%  { opacity:1; }
  100% { opacity:0; }
}




  .frame{
    width: 92%;
    max-width: 460px;
    border-radius: 30px;
    padding: 1.5px;
    background: linear-gradient(135deg,
      rgba(241,223,177,.96),
      rgba(216,182,122,.20),
      rgba(255,90,118,.11)
    );
    box-shadow: var(--shadow);
    position: relative;
    z-index: 1; /* sopra l'ambient */
  }

  .card{
    border-radius: 28px;
    padding: 18px 18px 16px;
    background: linear-gradient(180deg, var(--card1), var(--card2));
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    position: relative;

    max-height: 80vh;
    overflow: auto;
    -webkit-overflow-scrolling: touch;

    isolation: isolate; /* stacking pi√π pulito */
  }

  /* ‚úÖ FIX ‚Äúsbordamento‚Äù su iPhone:
     quando il glow ambient √® ON, la card diventa pi√π ‚Äúsolida‚Äù
     e riduciamo l‚Äôeffetto backdrop che mischia il glow dentro.
  */
  body.goldAmbient.on .card{
    background: linear-gradient(180deg, rgba(14,15,22,.90), rgba(18,19,30,.82));
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  /* Se vuoi ‚Äúzero invasione‚Äù (pi√π netto): decommenta queste 2 righe
  body.goldAmbient.on .card{ backdrop-filter:none; -webkit-backdrop-filter:none; }
  */

  .card::before{
    content:"";
    position:absolute; inset:0;
    border-radius: 28px;
    background-image: radial-gradient(rgba(255,255,255,.06) 1px, transparent 1px);
    background-size: 24px 24px;
    opacity:.05;
    pointer-events:none;
    z-index: 0;
  }

  /* ‚ú® inner glow nella card */
  .card::after{
    content:"";
    position:absolute;
    inset:0;
    border-radius: 28px;
    pointer-events:none;
    z-index: 0;
    box-shadow:
      0 0 0 1px rgba(241,223,177,.09) inset,
      0 0 28px rgba(241,223,177,.08) inset,
      0 0 70px rgba(216,182,122,.06) inset;
    opacity: .95;
  }

  .topRow{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 999px;
    background: rgba(216,182,122,.09);
    border: 1px solid rgba(216,182,122,.18);
    color: rgba(241,223,177,.96);
    font-weight: 800;
    font-size: 12.5px;
    letter-spacing: .25px;
  }

  h1{
    position: relative;
    z-index: 1;
    margin: 6px 0 6px;
    font-family: var(--font-title);
    font-size: 30px;
    letter-spacing: .25px;
    color: var(--gold2);
  }

  p{
    position: relative;
    z-index: 1;
    margin: 10px 0;
    font-size: 16px;
    line-height: 1.45;
    color: rgba(245,242,234,.95);
  }

  .muted{
    color: rgba(207,199,187,.90);
    font-size: 14px;
    margin-top: 0;
  }

  .divider{
    height:1px;
    background: linear-gradient(90deg, transparent, rgba(216,182,122,.20), transparent);
    margin: 14px 0 12px;
    position: relative;
    z-index: 1;
  }

  .buttons{
    margin-top: 14px;
    height: 120px;
    position: relative;
    z-index: 1;
  }

  button{
    border: none;
    border-radius: 999px;
    padding: 13px 18px;
    font-size: 16px;
    cursor: pointer;
    transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    user-select:none;
    position: relative;
    overflow: hidden;
  }
  button:active{ transform: translateY(1px) scale(.99); }

  #yesBtn{
    position:absolute;
    left:50%;
    top:0;
    transform: translateX(-50%);
    color: #19171a;
    background: linear-gradient(135deg, rgba(241,223,177,.98), rgba(216,182,122,.92));
    box-shadow: 0 14px 26px rgba(216,182,122,.20);
    font-weight: 900;
    letter-spacing: .2px;
  }

  #noBtn{
    position:absolute;
    left:50%;
    top:62px;
    transform: translateX(-50%);
    color: rgba(245,242,234,.92);
    background: rgba(255,255,255,.055);
    border: 1px solid rgba(255,255,255,.10);
    touch-action: manipulation;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding: 9px 12px;
    border-radius: 999px;
    background: rgba(216,182,122,.085);
    border: 1px solid rgba(216,182,122,.18);
    color: rgba(241,223,177,.95);
    font-size: 13px;
    margin-top: 10px;
    position: relative;
    z-index: 1;
  }

  .hidden{ display:none; }

  #final{
    margin-top: 10px;
    position: relative;
    z-index: 1;
  }

  .actionsRow{
    display:flex;
    gap:10px;
    justify-content:center;
    align-items:center;
    flex-wrap: wrap;
    margin: 10px 0 6px;
    position: relative;
    z-index: 1;
  }

  .ghostBtn{
    background: rgba(255,255,255,.055);
    border: 1px solid rgba(241,223,177,.18);
    color: rgba(241,223,177,.95);
    font-weight: 900;
    box-shadow: 0 14px 26px rgba(0,0,0,.22);
  }

  .toastBtn{
    color:#15131a;
    font-weight: 900;
    background: linear-gradient(135deg, rgba(241,223,177,.96), rgba(216,182,122,.68));
    box-shadow: 0 16px 30px rgba(216,182,122,.16);
  }

  /* ripple elegante sul toast */
  .toastBtn::after{
    content:"";
    position:absolute;
    left: var(--rx, 50%);
    top: var(--ry, 50%);
    width: 12px;
    height: 12px;
    border-radius: 999px;
    transform: translate(-50%,-50%) scale(0);
    opacity: 0;
    background: radial-gradient(circle, rgba(255,255,255,.65), rgba(255,255,255,0) 65%);
    pointer-events:none;
  }
  .toastBtn.ripple::after{ animation: ripple 650ms ease-out; }
  @keyframes ripple{
    0%   { opacity:0; transform: translate(-50%,-50%) scale(0); }
    15%  { opacity:.8; }
    100% { opacity:0; transform: translate(-50%,-50%) scale(26); }
  }

  .toastLine{
    text-align:center;
    font-size: 13.5px;
    color: rgba(207,199,187,.92);
    margin-top: 6px;
    position: relative;
    z-index: 1;
  }

  /* ‚úÖ FIX immagine */
  .photo{
    width:100%;
    height: 220px;
    object-fit: cover;
    object-position: center;
    border-radius: 18px;
    margin: 10px 0 6px;
    box-shadow: 0 18px 35px rgba(0,0,0,.35);
    animation: photoIn 520ms ease both;
    image-rendering: auto;
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    position: relative;
    z-index: 1;
  }
  @keyframes photoIn{
    from{ opacity:0; transform: translateY(8px) scale(.97); }
    to{ opacity:1; transform: translateY(0) scale(1); }
  }

  .grid{ display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; position:relative; z-index:1; }

  .panel{
    background: linear-gradient(180deg, var(--panel1), var(--panel2));
    border: 1px solid rgba(216,182,122,.16);
    border-radius: 18px;
    padding: 12px;
    position: relative;
    overflow:hidden;
  }

  .panel::before{
    content:"";
    position:absolute;
    left:0; top:0; bottom:0;
    width: 9px;
    background: linear-gradient(180deg,
      rgba(241,223,177,.40),
      rgba(216,182,122,.25),
      rgba(255,90,118,.10)
    );
    opacity:.9;
  }

  .panelHeader{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 8px;
    padding-left: 10px;
  }

  .panelTitle{
    margin:0;
    font-size: 14.5px;
    color: rgba(241,223,177,.95);
    display:flex;
    align-items:center;
    gap: 8px;
    letter-spacing: .2px;
  }

  .result{
    margin-top: 8px;
    font-size: 14.5px;
    color: rgba(245,242,234,.94);
    text-align:center;
    padding-left: 10px;
  }

  /* ---------- Central Scratch ---------- */
  .central{
   transform: translateZ(0);
    padding: 14px;
    border-radius: 20px;
    border: 1px solid rgba(241,223,177,.28);
    background:
      radial-gradient(650px 240px at 25% 20%, rgba(216,182,122,.13), rgba(0,0,0,0)),
      radial-gradient(700px 260px at 85% 40%, rgba(255,90,118,.08), rgba(0,0,0,0)),
      linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.03));
    position: relative;
    z-index: 1;
 overflow: hidden;     /* ‚úÖ IMPORTANTISSIMO: taglia lo sbordo */
  isolation: isolate;
    /* glow interno SEMPRE */
    box-shadow:
      0 0 0 1px rgba(241,223,177,.11) inset,
      0 0 36px rgba(241,223,177,.09) inset,
      0 0 90px rgba(216,182,122,.06) inset;
  }

  /* glow ‚Äúflash‚Äù quando brindiamo */
.central::after{
  content:"";
  position:absolute;
  inset: 0;
  border-radius: 20px;
  pointer-events:none;
  opacity: 0;

  /* ‚úÖ Safari: taglia SEMPRE il blur */
  clip-path: inset(0 round 20px);
  -webkit-clip-path: inset(0 round 20px);

  /* ‚úÖ evita che il blur ‚Äúspinga fuori‚Äù */
  filter: blur(10px) saturate(1.35);
  transform: translateZ(0);

  background: radial-gradient(circle at 50% 35%,
    rgba(241,223,177,.36),
    rgba(216,182,122,.22),
    rgba(241,223,177,0) 62%);
}

  .central.ambientGlow::after{ animation: ambientGlow 820ms ease-out both; }
  @keyframes ambientGlow{
    0%   { opacity:0; transform: scale(.97); }
    30%  { opacity:1; transform: scale(1.02); }
    100% { opacity:0; transform: scale(1.07); }
  }

  .centralTitle{
    font-family: var(--font-title);
    font-size: 18px;
    letter-spacing: .35px;
    color: var(--gold2);
    margin: 0 0 6px 10px;
  }

  .centralSub{
    margin: 0 0 10px 10px;
    color: rgba(207,199,187,.90);
    font-size: 13px;
  }

  .scratchWrap{
    position:relative;
    border-radius: 18px;
    overflow:hidden;
    border: 1px solid rgba(241,223,177,.28);
    background: rgba(0,0,0,.22);
    margin-left: 10px;
    min-height: 185px;
    box-shadow: 0 18px 40px rgba(0,0,0,.34);
  }

  .scratchPrize{
    position: relative;
    z-index: 1;
    padding: 18px 14px 18px;
    text-align:center;
  }

  .scratchPrize .big{
    font-family: var(--font-title);
    font-size: 22px;
    color: rgba(241,223,177,.98);
    font-weight: 800;
    margin-bottom: 10px;
    letter-spacing: .7px;
  }

  .scratchPrize .small{
    font-size: 15px;
    color: rgba(245,242,234,.95);
    line-height: 1.55;
  }

  canvas#scratchCanvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    touch-action:none;
    cursor:grab;
    z-index: 5;
  }

  .scratchHint{
    margin-top: 10px;
    font-size: 13px;
    color: rgba(241,223,177,.92);
    text-align:center;
    opacity:.95;
    padding-left: 10px;
  }

  .reserved{
    margin-top:10px;
    text-align:center;
    color: rgba(241,223,177,.96);
    font-weight: 900;
    letter-spacing: .45px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(241,223,177,.20);
    background:
      radial-gradient(420px 120px at 50% 10%, rgba(216,182,122,.18), rgba(0,0,0,0)),
      rgba(216,182,122,.07);
    box-shadow: 0 16px 30px rgba(0,0,0,.22);
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 320ms ease, transform 320ms ease;
  }
  .reserved.show{ opacity: 1; transform: translateY(0); }

  /* Sparkle burst */
  .burstPiece{
    position:absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    pointer-events:none;
    z-index: 40;
    opacity: 0;
    animation: burst 900ms ease-out forwards;
    text-shadow: 0 10px 16px rgba(0,0,0,.35);
  }
  @keyframes burst{
    0%   { opacity:0; transform: translate(-50%,-50%) scale(.85); }
    15%  { opacity:1; }
    100% { opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.2); }
  }

  .floaty{
    position: fixed;
    bottom:-30px;
    animation: floatUp 4.2s linear forwards;
    pointer-events:none;
    filter: drop-shadow(0 8px 10px rgba(0,0,0,.35));
    z-index: 5;
  }
  @keyframes floatUp{ to{ transform: translateY(-110vh); opacity:0; } }

  .foilDot{
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    pointer-events:none;
    opacity: 0;
    z-index: 60;
    animation: foil 920ms ease-out forwards;
    filter: drop-shadow(0 10px 16px rgba(0,0,0,.25));
  }
  @keyframes foil{
    0%   { opacity:0; transform: translate(-50%,-50%) scale(.85); }
    15%  { opacity:1; }
    100% { opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.12); }
  }

  .bubble{
    position:absolute;
    left:50%;
    top: 55%;
    transform: translate(-50%,-50%);
    pointer-events:none;
    opacity:0;
    z-index: 60;
    animation: bubble 1100ms ease-out forwards;
    filter: drop-shadow(0 10px 16px rgba(0,0,0,.25));
  }
  @keyframes bubble{
    0%   { opacity:0; transform: translate(-50%,-50%) scale(.9); }
    15%  { opacity:1; }
    100% { opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.25); }
  }

  .toastBtn.toastPop{
    animation: toastPop 320ms ease-out;
    box-shadow: 0 18px 40px rgba(216,182,122,.22), 0 0 22px rgba(241,223,177,.18);
  }
  @keyframes toastPop{
    0%{ transform: translateY(0) scale(1); }
    35%{ transform: translateY(-1px) scale(1.02); }
    70%{ transform: translateY(0) scale(.995); }
    100%{ transform: translateY(0) scale(1); }
  }

  .toastParticle{
    position: fixed;
    left: 0; top: 0;
    transform: translate(-50%,-50%);
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
    animation: toastParticle 900ms ease-out forwards;
    filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
  }
  @keyframes toastParticle{
    0%   { opacity:0; transform: translate(-50%,-50%) scale(.85); }
    12%  { opacity:1; }
    100% { opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.2); }
  }

  .champDrop{
    position: fixed;
    left: 0; top: 0;
    width: 10px;
    height: 10px;
    border-radius: 999px;
    transform: translate(-50%,-50%);
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
    animation: champFly 1150ms cubic-bezier(.18,.75,.3,1) forwards;
    filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
  }
  .champDrop.star{
    width: auto;
    height: auto;
    border-radius: 0;
    background: transparent !important;
    font-weight: 900;
  }
  @keyframes champFly{
    0%   { opacity: 0; transform: translate(-50%,-50%) scale(.9); }
    12%  { opacity: 1; }
    100% {
      opacity: 0;
      transform:
        translate(calc(-50% + var(--dx)), calc(-50% + var(--dy)))
        scale(var(--s, 1.05));
    }
  }

  /* üíõ Glow Brindiamo: esterno + interno */
  .toastBtn.goldGlow{
    box-shadow:
      0 18px 44px rgba(216,182,122,.34),
      0 0 0 1px rgba(241,223,177,.22) inset,
      0 0 18px rgba(241,223,177,.18) inset,
      0 0 38px rgba(241,223,177,.22);
  }
  .toastBtn.goldGlow::before{
    content:"";
    position:absolute;
    inset:-18px;
    border-radius:999px;
    background: radial-gradient(circle at 50% 50%,
      rgba(241,223,177,.40),
      rgba(241,223,177,0) 66%);
    opacity:0;
    transform: scale(.95);
    pointer-events:none;
  }
  .toastBtn.goldGlow.pulse{
    animation: goldPulse 1.15s ease-in-out infinite;
  }
  .toastBtn.goldGlow.pulse::before{
    animation: goldHalo 1.15s ease-in-out infinite;
  }

  @keyframes goldPulse{
    0%{
      filter: brightness(1);
      box-shadow:
        0 18px 44px rgba(216,182,122,.28),
        0 0 0 1px rgba(241,223,177,.22) inset,
        0 0 20px rgba(241,223,177,.18) inset,
        0 0 32px rgba(241,223,177,.20);
    }
    50%{
      filter: brightness(1.07);
      box-shadow:
        0 22px 56px rgba(216,182,122,.42),
        0 0 0 1px rgba(241,223,177,.30) inset,
        0 0 28px rgba(241,223,177,.24) inset,
        0 0 52px rgba(241,223,177,.30);
    }
    100%{
      filter: brightness(1);
      box-shadow:
        0 18px 44px rgba(216,182,122,.28),
        0 0 0 1px rgba(241,223,177,.22) inset,
        0 0 20px rgba(241,223,177,.18) inset,
        0 0 32px rgba(241,223,177,.20);
    }
  }
  @keyframes goldHalo{
    0%   { opacity:.10; transform: scale(.96); }
    50%  { opacity:.26; transform: scale(1.03); }
    100% { opacity:.10; transform: scale(.96); }
  }

  /* Slider */
  .sliderWrap{ display:grid; gap:8px; justify-items:center; padding-left:10px; }
  #loveRange{
    width:100%;
    -webkit-appearance:none;
    appearance:none;
    height: 10px;
    border-radius: 999px;
    outline:none;
    background: linear-gradient(90deg, var(--rose) 50%, rgba(255,90,118,.16) 50%);
  }
  #loveRange::-webkit-slider-runnable-track{ height:10px; border-radius:999px; background: transparent; }
  #loveRange::-moz-range-track{ height:10px; border-radius:999px; background: transparent; }
  #loveRange::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width: 30px;
    height: 30px;
    border-radius: 999px;
    border: 2px solid rgba(255,255,255,.72);
    cursor:pointer;
    margin-top: -10px;
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.65) 0 18%, rgba(255,255,255,0) 19% 100%),
      radial-gradient(circle at 55% 65%, rgba(255,190,90,.95) 0 35%, rgba(255,110,70,.95) 55%, rgba(255,90,118,1) 100%);
    box-shadow:
      0 10px 18px rgba(255,90,118,.16),
      0 0 16px rgba(255,110,70,.36);
  }
  #loveRange:active::-webkit-slider-thumb{ transform: scale(1.06); }
  #loveRange::-moz-range-thumb{
    width: 30px; height:30px; border-radius:999px;
    border: 2px solid rgba(255,255,255,.72);
    cursor:pointer;
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.65) 0 18%, rgba(255,255,255,0) 19% 100%),
      radial-gradient(circle at 55% 65%, rgba(255,190,90,.95) 0 35%, rgba(255,110,70,.95) 55%, rgba(255,90,118,1) 100%);
    box-shadow:
      0 10px 18px rgba(255,90,118,.16),
      0 0 16px rgba(255,110,70,.36);
  }

  /* Kiss counter */
  .kissWrap{ padding-left: 10px; display:grid; gap: 10px; position:relative; }
  .kissTop{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
  }
  .kissBig{
    font-size: 34px;
    font-weight: 900;
    letter-spacing: .6px;
    color: rgba(241,223,177,.98);
    line-height: 1;
    display:flex;
    align-items: baseline;
    gap: 8px;
  }
  .kissBig span{
    font-size: 13px;
    color: rgba(207,199,187,.95);
    font-weight: 700;
    letter-spacing: .2px;
  }

  .kissBar{
    width:100%;
    height: 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.07);
    border: 1px solid rgba(216,182,122,.16);
    overflow:hidden;
  }
  .kissFill{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(241,223,177,.92), rgba(255,90,118,.52));
    border-radius: 999px;
    transition: width 180ms ease;
  }

  .kissBtns{
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content:center;
  }
  .kissBtn{
    background: linear-gradient(135deg, rgba(241,223,177,.92), rgba(216,182,122,.55));
    color:#16151a;
    font-weight: 900;
    box-shadow: 0 14px 26px rgba(216,182,122,.14);
  }
  .kissReset{
    background: rgba(255,255,255,.055);
    border: 1px solid rgba(241,223,177,.18);
    color: rgba(245,242,234,.92);
  }

  .pop{ animation: pop 220ms ease-out; }
  @keyframes pop{ 0%{transform:scale(1)} 50%{transform:scale(1.06)} 100%{transform:scale(1)} }

  .kissFloat{
    position:absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    pointer-events:none;
    opacity: 0;
    animation: kissFloat 900ms ease-out forwards;
    z-index: 30;
    filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
  }
  @keyframes kissFloat{
    0%{ opacity:0; transform: translateX(-50%) translateY(0) scale(.9); }
    15%{ opacity:1; }
    100%{ opacity:0; transform: translateX(calc(-50% + var(--dx))) translateY(-110px) scale(1.15); }
  }

  @media (prefers-reduced-motion: reduce){
    body.goldAmbient.on::after{ animation:none !important; }
    .toastParticle, .champDrop, .burstPiece, .bubble, .foilDot, .floaty, .kissFloat { animation: none !important; opacity: 0 !important; }
    .toastBtn.toastPop, .toastBtn.goldGlow.pulse, .toastBtn.goldGlow.pulse::before { animation: none !important; }
    .central.ambientGlow::after { animation: none !important; opacity: 0 !important; }
  }
</style>
</head>

<body>
 <div id="ambientGlow"></div>

  <div class="frame">
    <div class="card" id="card">
      <div class="topRow">
        <div class="badge">ü•Ç Invito a cena</div>
      </div>

      <h1>Ammor mi' ‚ú®</h1>
      <p class="muted">Un invito originale... üòå</p>

      <p>
        Domanda importantissima:<br><br>
        Vuoi essere la mia <strong>Valentina di San Valentino</strong>? ü©∂
      </p>

      <div class="buttons">
        <button id="yesBtn">S√å üíò</button>
        <button id="noBtn">NO üôÑ</button>
      </div>

      <div id="status" class="pill hidden">‚ú®</div>

      <div class="divider"></div>

      <div id="final" class="hidden">
        <h1>TADAAAAAAANN ü•µ</h1>

        <div class="actionsRow">
          <button id="musicBtn" class="ghostBtn">‚ô™ Pausa</button>
          <button id="toastBtn" class="toastBtn">ü•Ç Brindiamo</button>
        </div>
        <div id="toastLine" class="toastLine">Un piccolo ‚Äúcin cin‚Äù prima di svelare tutto.</div>

        <div class="central" id="centralInvite">
          <div class="centralTitle">Il tuo invito ufficiale</div>
          <div class="centralSub">Gratta qui sotto per scoprire tutti i dettagli ‚ú®</div>

          <div class="scratchWrap" id="scratchBox">
            <div class="scratchPrize">
              <div class="big">Cena per due ü•Ç</div>
              <div class="small">
                üìç <strong>Venerd√¨ 14 Febbraio</strong><br>
                üï∞Ô∏è Ore 21:00<br>
                üç∑ Location: <strong>Carlo Fiamma</strong><br>
                ‚ú® Dress code: bella come sempre<br>
                (Andiamo con il pullman delle 20:25)
              </div>
            </div>
            <canvas id="scratchCanvas"></canvas>
          </div>

          <div class="scratchHint" id="scratchHint">Consiglio: gratta bene fino ai bordi üòâ</div>
          <div id="reserved" class="reserved">ü•Ç Tavolo prenotato</div>
        </div>

        <img class="photo" alt="Noi ü©∂" src="assets/noi.webp" loading="lazy" decoding="async" />

        <p>
          Allora √® deciso üòå<br><br>
          Una cena elegante (pizza tamarra), un brindisi (forse)‚Ä¶ e poi il resto lo vediamo dopo üòÆ<br><br>
          Se vuoi qui sotto puoi esprimere il tuo amore per me üëáüèº
        </p>

        <div class="grid">
          <div class="panel">
            <div class="panelHeader">
              <h3 class="panelTitle">ü©∂ Misuratore di amore</h3>
            </div>
            <div class="sliderWrap">
              <input id="loveRange" type="range" min="0" max="100" value="50" />
              <div id="loveText" class="result">Direi che siamo gi√† ad un ottimo livello üòå</div>
            </div>
          </div>

          <div class="panel" id="kissPanel">
            <div class="panelHeader">
              <h3 class="panelTitle">üòö Kiss counter</h3>
            </div>

            <div class="kissWrap">
              <div class="kissTop">
                <div class="kissBig" id="kissBig">0 <span>baci</span></div>
                <div style="color: rgba(207,199,187,.92); font-size: 13px; font-weight:700;">
                  obiettivo: <span id="kissGoal">30</span>
                </div>
              </div>

              <div class="kissBar">
                <div class="kissFill" id="kissFill"></div>
              </div>

              <div class="kissBtns">
                <button class="kissBtn" id="kissBtn">Bacio +1 üíã</button>
                <button class="kissReset" id="resetKissBtn">Reset üòá</button>
              </div>

              <div id="kissResult" class="result">Se rimane 0 non andiamo da nessuna parte üñïüèΩ</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="music" loop preload="auto">
    <source src="assets/song.mp3" type="audio/mpeg">
  </audio>

<script>
  const yesBtn = document.getElementById("yesBtn");
const noBtn = document.getElementById("noBtn");
const finalBox = document.getElementById("final");
const status = document.getElementById("status");

const music = document.getElementById("music");
const musicBtn = document.getElementById("musicBtn");

const toastBtn = document.getElementById("toastBtn");
const ambientGlowEl = document.getElementById("ambientGlow");
const toastLine = document.getElementById("toastLine");

const loveRange = document.getElementById("loveRange");
const loveText = document.getElementById("loveText");

const centralInvite = document.getElementById("centralInvite");
const scratchBox = document.getElementById("scratchBox");
const scratchCanvas = document.getElementById("scratchCanvas");
const scratchHint = document.getElementById("scratchHint");
const reserved = document.getElementById("reserved");

const kissPanel = document.getElementById("kissPanel");
const kissBtn = document.getElementById("kissBtn");
const resetKissBtn = document.getElementById("resetKissBtn");
const kissResult = document.getElementById("kissResult");
const kissFill = document.getElementById("kissFill");
const kissBig = document.getElementById("kissBig");
const kissGoalEl = document.getElementById("kissGoal");



  let noCount = 0;
  let floatiesStarted = false;

  // Kisses
  let kisses = 0;
  const kissGoal = 30;

  // Scratch
  let ctx = null;
  let isScratching = false;
  let scratchedEnough = false;
  let ratio = 1;

  // Cooldown effetti brindisi (evita spam)
  let lastToastFx = 0;
  const TOAST_FX_COOLDOWN = 220; // ms

  // Audio
  let musicStartedOnce = false;
  let fadeTimer = null;

  const reduceMotion = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches;

  function vibrate(pattern) {
    try { if (navigator.vibrate) navigator.vibrate(pattern); } catch (_) {}
  }

  function showStatus(msg) {
    status.textContent = "‚ú® " + msg;
    status.classList.remove("hidden");
  }

  function moveNoButton() {
    const container = document.querySelector(".buttons");
    const c = container.getBoundingClientRect();
    const b = noBtn.getBoundingClientRect();

    const padding = 8;
    const maxLeft = c.width - b.width - padding * 2;
    const maxTop  = c.height - b.height - padding * 2;

    const left = padding + Math.random() * Math.max(10, maxLeft);
    const top  = padding + Math.random() * Math.max(10, maxTop);

    noBtn.style.left = left + "px";
    noBtn.style.top  = top + "px";
    noBtn.style.transform = "none";
  }

  function startFloaties() {
    if (floatiesStarted || reduceMotion) return;
    floatiesStarted = true;

    const symbols = ["‚ù§Ô∏è","üíñ","üíï","‚ú®","‚≠ê","üåü","üí´"];
    setInterval(() => {
      const el = document.createElement("div");
      el.className = "floaty";
      el.textContent = symbols[Math.floor(Math.random() * symbols.length)];
      el.style.left = (Math.random() * 100) + "vw";
      el.style.fontSize = (Math.random() * 22 + 14) + "px";
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 4200);
    }, 250);
  }

  /* =========================
     üíõ GOLD VIBES (pulsante + ambient) -> SOLO con musica
     ========================= */
 

function startGoldVibes(){
  // classi sul body (servono per il tuo CSS: body.goldAmbient.on .card)
  document.body.classList.add("goldAmbient","on");

  // accende il layer ambient
  if (ambientGlowEl) ambientGlowEl.classList.add("on");

  // glow sul bottone brindiamo
  if (toastBtn) toastBtn.classList.add("goldGlow","pulse");
}

function stopGoldVibes(){
  document.body.classList.remove("on");

  if (ambientGlowEl) ambientGlowEl.classList.remove("on");
  if (toastBtn) toastBtn.classList.remove("pulse");
}



  /* =========================
     üéöÔ∏è Fade volume helper
     ========================= */
  function fadeVolumeTo(target, ms, onDone){
    try{
      if (fadeTimer) clearInterval(fadeTimer);
      const start = music.volume;
      const diff = target - start;
      const steps = Math.max(1, Math.floor(ms / 35));
      let i = 0;
      fadeTimer = setInterval(() => {
        i++;
        const v = start + diff * (i / steps);
        music.volume = Math.max(0, Math.min(1, v));
        if (i >= steps){
          clearInterval(fadeTimer);
          fadeTimer = null;
          music.volume = target;
          onDone?.();
        }
      }, 35);
    } catch (_){}
  }

  async function safePlayMusic() {
    try {
      if (!musicStartedOnce) {
        music.currentTime = 12; // cambia qui (secondi)
        musicStartedOnce = true;
      }

      music.volume = 0;
      await music.play();
      startGoldVibes();

      // fade-in
      fadeVolumeTo(0.35, 800);

      // micro-spray sincronizzato all‚Äôavvio
      if (!reduceMotion){
        setTimeout(() => {
          if (toastBtn) champagneSprayFromButton(toastBtn);
        }, 180);
      }
    } catch (_) {}
  }

  function fadeOutAndPause(){
    try{
      if (music.paused) return;
      fadeVolumeTo(0, 650, () => {
        music.pause();
        stopGoldVibes();
      });
    } catch(_){}
  }

  function doYesFlow() {
    finalBox.classList.remove("hidden");
    showStatus("questa √® la scelta giusta üòå");
    vibrate([40, 30, 40]);

    // parte la musica -> parte glow ambient
    safePlayMusic();
    startFloaties();
    initScratch();

    yesBtn.disabled = true;
    noBtn.disabled = true;
  }

  yesBtn.addEventListener("click", doYesFlow);

  noBtn.addEventListener("click", () => {
    noCount++;
    vibrate(25);

    if (noCount < 5) {
      const left = 5 - noCount;
      showStatus(`no? sei sicura? üòè (mancano ${left})`);
      moveNoButton();
      const texts = ["NO üôÑ", "NO? ü§®", "Ancora NO? üòå", "Dai su üòè", "Ok basta üò≥"];
      noBtn.textContent = texts[Math.min(noCount, texts.length - 1)];
    } else {
      showStatus("HAA godo ora devi accettare per forza ü§™");
      noBtn.textContent = "Ok hai vinto tu, S√å ‚ù§Ô∏è";
      noBtn.style.background = "linear-gradient(135deg, #f1dfb1, #d8b67a)";
      noBtn.style.color = "#19171a";
      noBtn.onclick = () => doYesFlow();
      vibrate([60, 40, 60]);
    }
  });

  // Music toggle (con fade in/out)
  if (musicBtn) {
    musicBtn.addEventListener("click", async () => {
      if (music.paused) {
        await safePlayMusic();
        musicBtn.textContent = "‚ô™ Pausa";
      } else {
        musicBtn.textContent = "‚ô™ Play";
        fadeOutAndPause();
      }
    });
  }

  // Sicurezza: se cambi tab, spegni con fade
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) fadeOutAndPause();
  });

  // ---------- Toast effects ----------
  const toastPhrases = [
    "Cin cin, principessa mia ü•Ç",
    "A noi. Sempre. ‚ú®",
    "Brindiamo a una serata perfetta üíñ",
    "Ok per√≤ ora non ti ubriacare.. üòê",
    "Ooo ti ho detto basta se no ti ubriachi üò°",
    "BASTAAAA ü§¨",
    "Vabbe ti amo, ubriacchiamoci insieme üòÅüòÅ"
  ];
  let toastIndex = 0;
  let toastMode = 0;

  function sparkleBurst(host){
    if (reduceMotion) return;
    const symbols = ["‚ú®","‚≠ê","üåü","üí´","ü•Ç"];
    for (let i = 0; i < 14; i++) {
      const s = document.createElement("div");
      s.className = "burstPiece";
      s.textContent = symbols[Math.floor(Math.random()*symbols.length)];
      s.style.setProperty("--dx", (Math.random()*220 - 110).toFixed(0) + "px");
      s.style.setProperty("--dy", (Math.random()*170 - 85).toFixed(0) + "px");
      s.style.fontSize = (12 + Math.random()*16).toFixed(0) + "px";
      host.appendChild(s);
      setTimeout(() => s.remove(), 950);
    }
  }

  function foilConfetti(host){
    if (reduceMotion) return;
    const dots = 18;
    for (let i = 0; i < dots; i++){
      const d = document.createElement("div");
      d.className = "foilDot";
      const isGold = Math.random() < 0.75;
      d.textContent = isGold ? "‚Ä¢" : "‚ú¶";
      d.style.color = isGold ? "rgba(241,223,177,.95)" : "rgba(255,90,118,.80)";
      d.style.setProperty("--dx", (Math.random()*240 - 120).toFixed(0) + "px");
      d.style.setProperty("--dy", (Math.random()*160 - 80).toFixed(0) + "px");
      d.style.fontSize = (14 + Math.random()*14).toFixed(0) + "px";
      host.appendChild(d);
      setTimeout(() => d.remove(), 940);
    }
  }

  function bubbleHearts(host){
    if (reduceMotion) return;
    const items = ["üíñ","üíï","‚ú®","‚≠ê"];
    for (let i = 0; i < 10; i++){
      const b = document.createElement("div");
      b.className = "bubble";
      b.textContent = items[Math.floor(Math.random()*items.length)];
      b.style.setProperty("--dx", (Math.random()*220 - 110).toFixed(0) + "px");
      b.style.setProperty("--dy", (-120 - Math.random()*120).toFixed(0) + "px");
      b.style.fontSize = (14 + Math.random()*18).toFixed(0) + "px";
      host.appendChild(b);
      setTimeout(() => b.remove(), 1120);
    }
  }

  function setRippleOnButton(btn, ev){
    const rect = btn.getBoundingClientRect();
    const x = ((ev?.clientX ?? (rect.left + rect.width/2)) - rect.left) / rect.width * 100;
    const y = ((ev?.clientY ?? (rect.top + rect.height/2)) - rect.top) / rect.height * 100;
    btn.style.setProperty("--rx", x + "%");
    btn.style.setProperty("--ry", y + "%");
    btn.classList.remove("ripple");
    void btn.offsetWidth;
    btn.classList.add("ripple");
  }

  function pulseToastBtn(btn){
    btn.classList.remove("toastPop");
    void btn.offsetWidth;
    btn.classList.add("toastPop");
  }

  function flashCentralGlow(host){
  host.classList.remove("ambientGlow");
  void host.offsetWidth;
  host.classList.add("ambientGlow");
  setTimeout(() => host.classList.remove("ambientGlow"), 820);
}


  function toastParticlesFromButton(btn){
    if (reduceMotion) return;
    const r = btn.getBoundingClientRect();
    const x = r.left + r.width/2;
    const y = r.top + r.height/2;

    const symbols = ["ü•Ç","‚ú®","üí´","‚≠ê","üíñ","üíï"];
    const n = 10;

    for (let i = 0; i < n; i++){
      const p = document.createElement("div");
      p.className = "toastParticle";
      p.textContent = symbols[Math.floor(Math.random()*symbols.length)];
      p.style.left = x + "px";
      p.style.top  = y + "px";
      p.style.fontSize = (14 + Math.random()*16).toFixed(0) + "px";
      p.style.setProperty("--dx", (Math.random()*220 - 110).toFixed(0) + "px");
      p.style.setProperty("--dy", (-80 - Math.random()*190).toFixed(0) + "px");
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 920);
    }
  }

  function champagneSprayFromButton(btn){
    if (reduceMotion) return;
    const r = btn.getBoundingClientRect();
    const originX = r.left + r.width/2;
    const originY = r.top + r.height/2;

    const drops = 20;
    for (let i = 0; i < drops; i++){
      const d = document.createElement("div");
      const isStar = Math.random() < 0.20;
      d.className = "champDrop" + (isStar ? " star" : "");

      if (isStar){
        d.textContent = Math.random() < 0.5 ? "‚ú¶" : "‚ú®";
        d.style.color = Math.random() < 0.78 ? "rgba(241,223,177,.95)" : "rgba(255,90,118,.70)";
        d.style.fontSize = (12 + Math.random()*14).toFixed(0) + "px";
      } else {
        const isBubble = Math.random() < 0.65;
        d.style.background = isBubble
          ? "radial-gradient(circle at 30% 30%, rgba(255,255,255,.75), rgba(255,255,255,0) 65%)"
          : (Math.random() < 0.92 ? "rgba(241,223,177,.95)" : "rgba(255,90,118,.55)");
        const size = 6 + Math.random()*10;
        d.style.width = size.toFixed(0) + "px";
        d.style.height = size.toFixed(0) + "px";
        d.style.boxShadow = isBubble
          ? "0 0 0 1px rgba(241,223,177,.22) inset"
          : "none";
      }

      const dx = (Math.random()*160 - 80);
      const dy = (-220 - Math.random()*180);

      d.style.setProperty("--dx", dx.toFixed(0) + "px");
      d.style.setProperty("--dy", dy.toFixed(0) + "px");
      d.style.setProperty("--s", (0.9 + Math.random()*0.6).toFixed(2));

      d.style.left = originX + "px";
      d.style.top  = originY + "px";

      document.body.appendChild(d);
      setTimeout(() => d.remove(), 1200);
    }
  }

  if (toastBtn) {
    toastBtn.addEventListener("click", (e) => {
      const now = Date.now();
      const canFx = (now - lastToastFx) > TOAST_FX_COOLDOWN;
      if (canFx) lastToastFx = now;

      toastIndex = (toastIndex + 1) % toastPhrases.length;
      toastLine.textContent = toastPhrases[toastIndex];

      setRippleOnButton(toastBtn, e);
      pulseToastBtn(toastBtn);
     flashCentralGlow(centralInvite);


      if (canFx) {
        toastParticlesFromButton(toastBtn);
        champagneSprayFromButton(toastBtn);
      }

      toastMode = (toastMode + 1) % 3;
      if (toastMode === 0) foilConfetti(centralInvite);
      if (toastMode === 1) sparkleBurst(centralInvite);
      if (toastMode === 2) bubbleHearts(centralInvite);

      vibrate(18);
    });
  }

  // Slider fill
  function paintLoveRange(){
    const v = Number(loveRange.value);
    loveRange.style.background =
      `linear-gradient(90deg, var(--rose) ${v}%, rgba(255,90,118,.16) ${v}%)`;
  }

  function updateLoveText(v) {
    if (v < 20) return "Mh, impossibile... hai sbagliato persona üòí";
    if (v < 40) return "Stai iniziando a convincerti‚Ä¶ brava üòè";
    if (v < 60) return "Direi che siamo gi√† ad un ottimo livello üòå";
    if (v < 80) return "Wow. Qua il livello √® altissimo! üíï";
    return "Ngul, livello amore massimo. Ti amo! ü©∂";
  }

  paintLoveRange();
  loveText.textContent = updateLoveText(Number(loveRange.value));
  loveRange.addEventListener("input", () => {
    loveText.textContent = updateLoveText(Number(loveRange.value));
    paintLoveRange();
  });

  /* ---------- KISS COUNTER ---------- */
  kissGoalEl.textContent = String(kissGoal);

  function setKissBig(){
    kissBig.textContent = `${kisses} `;
    const span = document.createElement("span");
    span.textContent = "baci";
    kissBig.appendChild(span);
  }

  function updateKissUI(){
    setKissBig();
    const pct = Math.min(100, Math.round((kisses / kissGoal) * 100));
    kissFill.style.width = pct + "%";

    if (kisses === 0) kissResult.textContent = "Se rimane 0 non andiamo da nessuna parte üñïüèΩ";
    else if (kisses < 10) kissResult.textContent = "Ok‚Ä¶ cos√¨ mi stai iniziando a scaldare üòå";
    else if (kisses < 20) kissResult.textContent = "Qui la situazione sta diventando piccante üò¨";
    else if (kisses < kissGoal) kissResult.textContent = "Uhhh, oh fuck oh yes üòè";
    else kissResult.textContent = "Stasera sei mia!! Non scapperai!!! ü´£ü§≠";
  }

  function kissPop(){
    kissBig.classList.remove("pop");
    void kissBig.offsetWidth;
    kissBig.classList.add("pop");
  }

  function spawnKissFloat(){
    if (reduceMotion) return;
    const el = document.createElement("div");
    el.className = "kissFloat";
    el.textContent = ["üíã","üíï","üíñ","‚ù§Ô∏è","‚ú®","‚≠ê"][Math.floor(Math.random()*6)];
    el.style.setProperty("--dx", (Math.random()*120 - 60) + "px");
    kissPanel.appendChild(el);
    setTimeout(() => el.remove(), 950);
  }

  updateKissUI();

  kissBtn.addEventListener("click", () => {
    kisses++;
    vibrate(12);
    updateKissUI();
    kissPop();
    spawnKissFloat();
  });

  resetKissBtn.addEventListener("click", () => {
    kisses = 0;
    updateKissUI();
    vibrate([20,20,20]);
  });

  /* ---------- Scratch ---------- */
  function scratchBurst(){
    if (reduceMotion) return;
    const symbols = ["‚ú®","‚≠ê","üåü","üí´","‚ù§Ô∏è","ü•Ç"];
    for (let i = 0; i < 22; i++) {
      const s = document.createElement("div");
      s.className = "burstPiece";
      s.textContent = symbols[Math.floor(Math.random()*symbols.length)];
      s.style.setProperty("--dx", (Math.random()*280 - 140).toFixed(0) + "px");
      s.style.setProperty("--dy", (Math.random()*250 - 125).toFixed(0) + "px");
      s.style.fontSize = (14 + Math.random()*18).toFixed(0) + "px";
      centralInvite.appendChild(s);
      setTimeout(() => s.remove(), 950);
    }
  }

  function resizeCanvasToBox() {
    const rect = scratchBox.getBoundingClientRect();
    ratio = Math.max(1, window.devicePixelRatio || 1);

    scratchCanvas.width = Math.floor(rect.width * ratio);
    scratchCanvas.height = Math.floor(rect.height * ratio);
    scratchCanvas.style.width = rect.width + "px";
    scratchCanvas.style.height = rect.height + "px";

    ctx = scratchCanvas.getContext("2d", { willReadFrequently: true });
    ctx.setTransform(1, 0, 0, 1, 0, 0);
  }

  function drawCover() {
    if (!ctx) return;
    const w = scratchCanvas.width;
    const h = scratchCanvas.height;

    const g = ctx.createLinearGradient(0, 0, w, h);
    g.addColorStop(0, "#1a1a22");
    g.addColorStop(0.55, "#11111a");
    g.addColorStop(1, "#0c0c12");

    ctx.globalCompositeOperation = "source-over";
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, w, h);

    for (let i = 0; i < 160; i++) {
      const a = Math.random() * 0.08;
      ctx.fillStyle = (Math.random() < 0.80)
        ? `rgba(216,182,122,${a})`
        : `rgba(255,90,118,${a * 0.65})`;
      ctx.beginPath();
      ctx.arc(Math.random() * w, Math.random() * h, Math.random() * 2.6 + 0.5, 0, Math.PI * 2);
      ctx.fill();
    }

    ctx.fillStyle = "rgba(241,223,177,0.90)";
    ctx.font = `900 ${Math.floor(18 * ratio)}px Inter`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("GRATTA QUI ‚ú®", w / 2, h / 2);
  }

  function scratchAt(clientX, clientY) {
    if (!ctx || scratchedEnough) return;

    const rect = scratchCanvas.getBoundingClientRect();
    const xCss = clientX - rect.left;
    const yCss = clientY - rect.top;

    const x = Math.floor(xCss * ratio);
    const y = Math.floor(yCss * ratio);

    ctx.globalCompositeOperation = "destination-out";
    ctx.beginPath();
    ctx.arc(x, y, Math.floor(22 * ratio), 0, Math.PI * 2);
    ctx.fill();

    checkScratchProgress(false);
  }

  let lastCheck = 0;
  function checkScratchProgress(force){
    const now = Date.now();
    if (!force && now - lastCheck < 260) return;
    lastCheck = now;

    const img = ctx.getImageData(0, 0, scratchCanvas.width, scratchCanvas.height).data;

    const stride = 28;
    let cleared = 0, total = 0;

    for (let i = 3; i < img.length; i += 4 * stride) {
      total++;
      if (img[i] < 25) cleared++;
    }

    const pct = cleared / Math.max(1, total);

    if (pct > 0.45 && !scratchedEnough) {
      scratchedEnough = true;

      ctx.clearRect(0, 0, scratchCanvas.width, scratchCanvas.height);
      scratchHint.textContent = "Svelato. ü•Ç‚ú® Si, √® la stessa location di l'anno scorso perch√® sono sempre senza mezzo e senza soldi üòÑ";
      vibrate([30, 30, 30]);

      scratchBurst();
      if (reserved) reserved.classList.add("show");
    }
  }

  function initScratch() {
    if (ctx) return;
    scratchedEnough = false;
    if (reserved) reserved.classList.remove("show");

    resizeCanvasToBox();
    drawCover();

    const onDown = (e) => {
      isScratching = true;
      const p = getPoint(e);
      scratchAt(p.x, p.y);
      vibrate(8);
    };

    const onMove = (e) => {
      if (!isScratching) return;
      e.preventDefault();
      const p = getPoint(e);
      scratchAt(p.x, p.y);
    };

    const onUp = () => {
      isScratching = false;
      if (ctx && !scratchedEnough) checkScratchProgress(true);
    };

    scratchCanvas.addEventListener("pointerdown", onDown, { passive: true });
    scratchCanvas.addEventListener("pointermove", onMove, { passive: false });
    window.addEventListener("pointerup", onUp, { passive: true });

    window.addEventListener("resize", () => {
      const done = scratchedEnough;
      ctx = null;
      resizeCanvasToBox();
      if (!done) drawCover();
      else {
        const c = scratchCanvas.getContext("2d");
        c.clearRect(0,0,scratchCanvas.width,scratchCanvas.height);
      }
    }, { passive: true });
  }

  function getPoint(e) {
    if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    return { x: e.clientX, y: e.clientY };
  }
</script>

</body>
</html>









